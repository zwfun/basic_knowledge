# 浏览器

等待资源加载时间和大部分情况下的浏览器单线程执行是影响Web性能的两大主要原因

#### 浏览器渲染流程

#### 浏览器垃圾回收
标记清除法 - 假定存在一个根对象垃圾回收期将定期从根对象开始查找，凡事从根部出发能到的都会保留，扫描不到的将被回收
- 一组基本的无法删除的根元素
    - 全局变量
    - 本地函数的局部变量和参数
    - 当前嵌套调用链上的其他函数的变量和参数
- 如果引用或者引用链可以从根访问任何其他值，则认为该值是可访问的
- 如果不可访问就是垃圾，会被回收
- https://segmentfault.com/a/1190000018605776
- https://segmentfault.com/a/1190000037588250

几种常见的内存泄露
- 去哪及变量
- 未移除的时间绑定
- 无效的DOM
- 定时器setTimeout/setInterval

#### 优化 CRP
提升页面加载速度需要通过被加载资源的优先级、控制它们加载的顺序和减小这些资源的体积。性能提示包含 1）通过异步重要资源的下载来减小请求数量，2）优化必须的请求数量和每个请求的文件体积，3）通过区分关键资源的优先级来优化被加载关键资源的顺序，来缩短关键路径长度。

#### 参考资料

- https://juejin.im/post/6844903873887338510
- https://developer.mozilla.org/zh-CN/docs/Web/Performance/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86
- https://developer.mozilla.org/zh-CN/docs/Web/Performance
- [读懂浏览器渲染流程](https://www.sohu.com/a/223805109_820120)



#### 浏览器的加载流程

- 服务端请求和响应
    - 通过域名查找DNS(如果之前没有访问过)获取ip地址
    - 获得了IP地址通过TCP与服务器建立连接
    - 响应请求
- 加载过程
    - 解析html文档，浏览器通过网络接收的数据转换为DOM和CSSOM的步骤，通过渲染器把DOM和CSSOM在屏幕上绘制成页面
    - 构建DOM树
- 执行脚本
    - JavaScript被解释、编译、解析和执行。脚本被解析为抽象语法树。一些浏览器引擎使用”Abstract Syntax Tree“并将其传递到解释器中，输出在主线程上执行的字节码。这就是所谓的JavaScript编译
- 渲染
    - 渲染步骤包括样式、布局、绘制，在某些情况下还包括合成。在解析步骤中创建的CSSOM树和DOM树组合成一个Render树，然后用于计算每个可见元素的布局，然后将其绘制到屏幕上。在某些情况下，可以将内容提升到它们自己的层并进行合成，通过在GPU而不是CPU上绘制屏幕的一部分来提高性能，从而释放主线程
- 样式
    - 
- 布局
- 绘制

#### 建立链接

- 输入域名，通过DNS(域名服务器)查找服务器对应的IP地址
- 浏览器用过TCP三次握手与服务器建立连接

``` DNS查找域名耗时间所以最好资源的域名要相同，特别是移动网络用户 每一个DNS查找必须从手机发送到信号塔，然后到达一个认证DNS服务器 ```
  
#### 加载文件
- http1.0 每个文件都要建立一个tcp连接
- http1.1 相同域名可以建立持久连接、支持断点续传、新增了24个错误状态响应码，但是并行请求的连接数只能是4-6个，会阻塞资源的请求
- http1.2 相同域名下只建立一个请求连接通过增加包分帧层将多个资源分成更小的包进行传输，通过不同的头部字段进行区分不同的资源文件

#### 加载解析过程

输入url,加载html. 解析html 构建DOM( document object model)和CSSOM. 构建DOM过程中如果遇到css文件或者js文件就会阻塞DOM的构建， 直到请求回来js并解析执行后才会继续构建。js文件可以会用async和defer来消除js阻塞， 区别在于async会时DOM继续解析 并且加快js并行请求 但是js加载回来还是会阻塞DOM的解析的。 如果用的是defer js则会等到DOM解析完成后再执行。


#### 渲染过程
DOM树和CSSOM树加载完成后构建一棵渲染树，并计算每个可见元素的布局 然后将其绘制到屏幕上。 
- 样式是将DOM和CSSOM组合成一个Render树，计算样式树或渲染树从DOM树的根开始构建，遍历每个可见节点。
- 布局是确定呈现树中所有节点的宽度、高度和位置，以及确定页面上每个对象的大小和位置的过程
- 浏览器将在布局阶段计算的每个框转换为屏幕上的实际像素。绘画包括将元素的每个可视部分绘制到屏幕上
- 合成是当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容
- 交互是一旦主线程绘制页面完成，如果加载包含JavaScript（并且延迟到onload事件激发后执行），则主线程可能很忙，无法用于滚动、触摸和其他交互。